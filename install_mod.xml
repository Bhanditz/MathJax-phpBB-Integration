<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--NOTICE: Please open this file in your web browser. If presented with a security warning, you may safely tell it to allow the blocked content.-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
	<header>
		<license><![CDATA[http://opensource.org/licenses/gpl-license.php GNU General Public License v2]]></license>
		<title lang="en"><![CDATA[MathJax phpBB Integration]]></title>
		<description lang="en"><![CDATA[Integrates MathJax Javascript Library with phpBB to enable [LaTeX] posts.]]></description>
		<author-notes lang="en"><![CDATA[]]></author-notes>
		<author-group>
			<author>
				<realname><![CDATA[SÃ©rgio Faria]]></realname>
				<username><![CDATA[sergio91pt]]></username>
				<homepage><![CDATA[https://github.com/sergio91pt/MathJax-phpBB-Integration]]></homepage>
				<email><![CDATA[sergio91pt@gmail.com]]></email>
			</author>
		</author-group>
		<mod-version>0.2.0</mod-version>
		<installation>
			<level>easy</level>
			<time>300</time>
			<target-version>3.0.9</target-version>
		</installation>
		<history>
			<entry>
				<date>2011-07-23</date>
				<rev-version>0.2.0</rev-version>
				<changelog lang="pt">
					
				</changelog>
			</entry>
			<entry>
				<date>2011-07-08</date>
				<rev-version>0.1.1</rev-version>
				<changelog lang="en">
					<change><![CDATA[Fixed 2 wrong variable names on add_table_entries.php]]></change>
				</changelog>
			</entry>
			<entry>
				<date>2011-07-08</date>
				<rev-version>0.1.0</rev-version>
				<changelog lang="en">
					<change><![CDATA[Initial Release.]]></change>
				</changelog>
			</entry>
		</history>
	</header>
	<action-group>
		<copy>
			<file from="/root/umil/*.*" to="umil/*.*"/>
			<file from="root/adm/mods/mathjax_mod_version.php" to="adm/mods/mathjax_mod_version.php"/>
			<file from="root/adm/style/acp_mathjax.html" to="adm/style/acp_mathjax.html"/>
			<file from="root/assets/javascript/phpbb2jax-combined-min.js" to="assets/javascript/phpbb2jax-combined-min.js"/>
			<file from="root/includes/acp/acp_mathjax.php" to="includes/acp/acp_mathjax.php"/>
			<file from="root/includes/acp/info/acp_mathjax.php" to="includes/acp/info/acp_mathjax.php"/>
			<file from="root/install/install.php" to="install/install.php"/>
			<file from="root/language/en/mods/info_acp_mathjax.php" to="language/en/mods/info_acp_mathjax.php"/>
			<file from="root/styles/prosilver/template/mathjax.html" to="styles/prosilver/template/mathjax.html"/>
		</copy>
		<open src="includes/bbcode.php">
			<edit>
				<find><![CDATA[					if (isset($rowset[$bbcode_id]))
					{]]></find>
				<action type="replace-with"><![CDATA[					global $config;

					if (isset($rowset[$bbcode_id]))
					{
						if (!empty($config['mathjax_enable']) && !empty($rowset[$bbcode_id]['is_math'])) 
						{
							$template->assign_var('S_ENABLE_MATHJAX', true);
						}
]]></action>
			</edit>
		</open>
		<open src="includes/functions.php">
			<edit>
				<find><![CDATA[		$s_search_hidden_fields['sid'] = $_SID;
	}]]></find>
				<action type="after-add"><![CDATA[
	// Start 'building' Mathjax url
	if (!empty($config['mathjax_enable']))
	{
		$mathjax_file = (!empty($config['mathjax_config'])) ? '/MathJax.js?config=' . $config['mathjax_config'] : '/MathJax.js';
		
		if(!empty($config['mathjax_use_cdn']))
		{
			if(!empty($config['mathjax_cdn_force_ssl']))
			{
				$mathjax_uri = $config['mathjax_cdn_ssl'];
			}
			else
			{
				$server_protocol = ($config['server_protocol']) ? $config['server_protocol'] : (($config['cookie_secure']) ? 'https://' : 'http://');
				$mathjax_uri = ($server_protocol === 'http://') ? $config['mathjax_cdn'] : $config['mathjax_cdn_ssl'];
			}
			$mathjax_uri_fallback = (!empty($config['mathjax_uri'])) ? ($config['mathjax_uri'] . $mathjax_file) : ''; 
		}
		else
		{
			$mathjax_uri = $config['mathjax_uri'] ;
		}

		$mathjax_uri = $mathjax_uri . $mathjax_file;
		
		if(empty($config['mathjax_dynamic_load']))
		{
			$template->assign_var('S_ENABLE_MATHJAX', true);
		}
	}]]></action>
			</edit>
			<edit>
				<find><![CDATA[		'U_FEED'				=> generate_board_url() . "/feed.$phpEx",]]></find>
				<action type="after-add"><![CDATA[		'U_MATHJAX'				=> (isset($mathjax_uri)) ? $mathjax_uri : '',
		'UA_MATHJAX_FALLBACK'	=> (isset($mathjax_uri_fallback)) ? $mathjax_uri_fallback : '',

		'S_MATHJAX_HAS_FALLBACK'=> (!empty($mathjax_uri_fallback)) ? true : false,]]></action>
			</edit>
			<edit>
				<find><![CDATA[		'S_SEARCH_HIDDEN_FIELDS'	=> build_hidden_fields($s_search_hidden_fields),]]></find>
				<action type="after-add"><![CDATA[		'T_ASSETS_PATH'      	=> "{$web_path}assets",]]></action>
			</edit>
		</open>
		<open src="styles/prosilver/template/overall_header.html">
			<edit>
				<find><![CDATA[</head>]]></find>
				<action type="before-add"><![CDATA[<!-- IF S_ENABLE_MATHJAX -->
<!-- INCLUDE mathjax.html -->
<!-- ENDIF -->]]></action>
			</edit>
		</open>
		<php-installer><![CDATA[install/install.php]]></php-installer>
		<!--<diy-instructions lang="en"><![CDATA[Remove the install folder.]]></diy-instructions>-->
		<delete> <!-- Is this only executed in the end? -->
			<file name="install/"></file>
		</delete>	
	</action-group>
</mod>
